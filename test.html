<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLSV Battle Arena - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #111827;
            overflow: hidden;
            touch-action: manipulation;
        }

        .game-grid {
            display: grid;
            height: 100%;
            width: 100%;
        }

        .cols-2 { grid-template-columns: repeat(2, 1fr); }
        .cols-3 { grid-template-columns: repeat(3, 1fr); }
        .cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 600px) and (orientation: portrait) {
            .cols-2 { grid-template-columns: 1fr; grid-template-rows: repeat(2, 1fr); }
            .cols-3 { grid-template-columns: 1fr; grid-template-rows: repeat(3, 1fr); }
            .cols-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        }

        .player-zone {
            position: relative;
            border-right: 2px solid rgba(255,255,255,0.1);
            border-left: 2px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            transition: all 0.2s;
            overflow: hidden;
        }

        .bonus-mode {
            background: linear-gradient(to bottom right, rgba(255,215,0,0.1), rgba(255,215,0,0.05));
            border: 2px solid #ffd700 !important;
        }

        .hp-bar-bg {
            background: rgba(0,0,0,0.5);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 4px;
        }

        .hp-bar-fill {
            height: 100%;
            transition: width 0.3s ease-out;
        }

        .timer-bar {
            height: 4px;
            background: #4b5563;
            margin-bottom: 8px;
            border-radius: 2px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: #fbbf24;
            transition: width 1s linear;
        }

        /* Animations */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        .damage-popup {
            position: absolute;
            font-size: 2.5rem;
            font-weight: 900;
            color: #ef4444;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 50;
            animation: floatUp 0.8s ease-out forwards;
        }
        
        .heal-popup {
            color: #22c55e;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1); opacity: 0; }
        }

        .btn-option {
            background: rgba(255,255,255,0.95);
            border-bottom: 3px solid #9ca3af;
            transition: all 0.1s;
            color: #1f2937;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-option:active {
            transform: translateY(2px);
            border-bottom: 0;
        }
        
        .overlay-dead {
            background: rgba(0,0,0,0.85);
            backdrop-filter: grayscale(1);
        }

        .control-btn {
            background: #374151;
            border: 2px solid #4b5563;
            border-radius: 8px;
            padding: 0.5rem;
            color: white;
            font-weight: bold;
        }
        .control-btn:active { transform: scale(0.95); }

        /* Math Display Enhancement */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        .fraction > span {
            display: block;
            padding: 0 2px;
        }
        .fraction span.top { border-bottom: 2px solid white; }
        .fraction span.bottom {  }
    </style>
</head>
<body class="h-screen w-screen text-white select-none overflow-hidden">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-4 text-center">
        <h1 class="text-4xl md:text-6xl font-black text-yellow-400 mb-1 tracking-tighter drop-shadow-lg">
            <i class="fas fa-bolt"></i> PLSV RUMBLE
        </h1>
        <p class="text-gray-400 mb-6 text-base md:text-lg">Ultimate Math Battle</p>

        <div class="bg-gray-800 p-6 rounded-2xl border-2 border-gray-700 w-full max-w-md shadow-2xl space-y-6">
            
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Jumlah Pemain</label>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectPlayers(2)" class="p-3 rounded-xl border-2 border-gray-600 hover:border-yellow-400 bg-gray-700 transition font-bold player-sel" id="btn-p2">2</button>
                    <button onclick="selectPlayers(3)" class="p-3 rounded-xl border-2 border-gray-600 hover:border-yellow-400 bg-gray-700 transition font-bold player-sel" id="btn-p3">3</button>
                    <button onclick="selectPlayers(4)" class="p-3 rounded-xl border-2 border-gray-600 hover:border-yellow-400 bg-gray-700 transition font-bold player-sel" id="btn-p4">4</button>
                </div>
            </div>

            <div class="bg-gray-700 p-4 rounded-xl">
                <label class="block text-xs font-bold text-gray-300 mb-2 uppercase tracking-wider"><i class="fas fa-stopwatch"></i> Waktu Per Soal</label>
                <div class="flex items-center justify-between">
                    <button onclick="adjustTimer(-5)" class="control-btn w-12"><i class="fas fa-minus"></i></button>
                    <div class="text-2xl font-bold text-yellow-400 w-20"><span id="timer-display">30</span>s</div>
                    <button onclick="adjustTimer(5)" class="control-btn w-12"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                <span class="font-bold text-sm"><i class="fas fa-music mr-2"></i> Suara & Musik</span>
                <button id="btn-audio" onclick="toggleAudio()" class="bg-red-500 w-10 h-6 rounded-full relative transition-colors">
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                </button>
            </div>

            <button onclick="initGame()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-black py-4 rounded-xl text-xl shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-1 transition hover:brightness-110">
                MULAI BATTLE!
            </button>
        </div>
    </div>

    <!-- GAME ARENA -->
    <div id="game-arena" class="hidden game-grid bg-gray-900">
        <!-- Player Zones -->
    </div>

    <!-- GAME OVER MODAL -->
    <div id="game-over" class="hidden absolute inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="text-center animate-bounce-in">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-5xl font-black text-white mb-2">GAME OVER</h2>
            <p id="winner-name" class="text-3xl font-bold text-yellow-400 mb-8">Player 1 Menang!</p>
            <button onclick="location.reload()" class="px-8 py-3 bg-white text-black font-black rounded-full text-xl hover:scale-105 transition">MAIN LAGI</button>
        </div>
    </div>

    <script>
        // --- AUDIO SYSTEM ---
        const AudioSys = {
            ctx: null,
            isEnabled: false,
            bgmInterval: null,
            
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if(!this.ctx) this.ctx = new AudioContext();
            },
            
            resume: function() {
                if(this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playTone: function(freq, type, duration, vol=0.1) {
                if (!this.isEnabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            sfxCorrect: function() {
                this.playTone(600, 'sine', 0.1, 0.15);
                setTimeout(() => this.playTone(1200, 'sine', 0.2, 0.15), 100);
            },
            sfxWrong: function() {
                this.playTone(150, 'sawtooth', 0.3, 0.2);
            },
            sfxAttack: function() {
                if (!this.isEnabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(500, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },
            sfxHeal: function() {
                this.playTone(400, 'sine', 0.1, 0.1);
                setTimeout(() => this.playTone(600, 'sine', 0.1, 0.1), 100);
                setTimeout(() => this.playTone(800, 'sine', 0.4, 0.1), 200);
            },
            sfxWin: function() {
                [300, 400, 500, 600, 800].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'square', 0.2, 0.1), i * 100);
                });
            },

            startBGM: function() {
                if(!this.isEnabled || !this.ctx) return;
                // Simple ambient loop
                let noteIdx = 0;
                const notes = [110, 130, 146, 130, 110, 98, 110, 110]; // Am pentatonic-ish bass
                
                if(this.bgmInterval) clearInterval(this.bgmInterval);
                
                this.bgmInterval = setInterval(() => {
                    if(!this.isEnabled || !gameActive) {
                        clearInterval(this.bgmInterval);
                        return;
                    }
                    
                    // Bass
                    this.playTone(notes[noteIdx % notes.length], 'triangle', 0.3, 0.05);
                    
                    // Hi-hat tick every 2 beats
                    if(noteIdx % 2 === 0) {
                        this.playTone(1000 + Math.random()*500, 'square', 0.05, 0.02);
                    }

                    noteIdx++;
                }, 500); // 120 BPM
            }
        };

        // --- GAME CONFIG ---
        let playerCount = 2;
        let gameTimeSetting = 30; 
        let players = [];
        let gameActive = false;

        const playerConfig = [
            { id: 0, color: 'bg-red-600', light: 'bg-red-900', text: 'text-red-400', border: 'border-red-500', icon: 'fa-dragon' },
            { id: 1, color: 'bg-blue-600', light: 'bg-blue-900', text: 'text-blue-400', border: 'border-blue-500', icon: 'fa-robot' },
            { id: 2, color: 'bg-green-600', light: 'bg-green-900', text: 'text-green-400', border: 'border-green-500', icon: 'fa-frog' },
            { id: 3, color: 'bg-purple-600', light: 'bg-purple-900', text: 'text-purple-400', border: 'border-purple-500', icon: 'fa-ghost' }
        ];

        // --- SETUP ---
        function selectPlayers(n) {
            playerCount = n;
            document.querySelectorAll('.player-sel').forEach(b => b.classList.remove('bg-gray-500', 'border-yellow-400'));
            document.getElementById(`btn-p${n}`).classList.add('bg-gray-500', 'border-yellow-400');
        }

        function adjustTimer(val) {
            gameTimeSetting += val;
            if(gameTimeSetting < 5) gameTimeSetting = 5;
            if(gameTimeSetting > 60) gameTimeSetting = 60;
            document.getElementById('timer-display').innerText = gameTimeSetting;
        }

        function toggleAudio() {
            AudioSys.isEnabled = !AudioSys.isEnabled;
            const btn = document.getElementById('btn-audio');
            const dot = btn.querySelector('.dot');
            if(AudioSys.isEnabled) {
                AudioSys.init();
                btn.classList.remove('bg-red-500');
                btn.classList.add('bg-green-500');
                dot.classList.add('translate-x-4');
                AudioSys.playTone(440, 'sine', 0.1);
            } else {
                btn.classList.add('bg-red-500');
                btn.classList.remove('bg-green-500');
                dot.classList.remove('translate-x-4');
            }
        }

        function initGame() {
            // 1. Resume Audio Context immediately on user click
            if(AudioSys.isEnabled) {
                AudioSys.init();
                AudioSys.resume();
            }

            document.getElementById('setup-screen').classList.add('hidden');
            const arena = document.getElementById('game-arena');
            arena.classList.remove('hidden');
            arena.className = `game-grid cols-${playerCount} bg-gray-900`;
            
            players = [];
            arena.innerHTML = '';
            gameActive = true;

            // Start BGM
            if(AudioSys.isEnabled) AudioSys.startBGM();

            for(let i=0; i<playerCount; i++) {
                players.push({
                    ...playerConfig[i],
                    hp: 100,
                    isDead: false,
                    state: 'THINKING', 
                    currentQ: null,
                    timeLeft: gameTimeSetting,
                    timerInterval: null
                });
                
                const zone = document.createElement('div');
                zone.id = `p-zone-${i}`;
                zone.className = `player-zone ${playerConfig[i].light}`;
                zone.innerHTML = buildPlayerHTML(i);
                arena.appendChild(zone);
                
                generateQuestionFor(i);
            }
        }

        function buildPlayerHTML(pid) {
            const p = players[pid];
            return `
                <div class="flex flex-col gap-1 mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full ${p.color} text-white flex items-center justify-center text-sm shadow-md shrink-0">
                            <i class="fas ${p.icon}"></i>
                        </div>
                        <div class="w-full">
                            <div class="flex justify-between text-[10px] font-bold text-gray-300">
                                <span>P${pid+1}</span>
                                <span id="hp-txt-${pid}">100</span>
                            </div>
                            <div class="hp-bar-bg">
                                <div id="hp-bar-${pid}" class="hp-bar-fill ${p.color}" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="timer-bar w-full bg-gray-700">
                    <div id="timer-fill-${pid}" class="timer-fill w-full"></div>
                </div>

                <div id="p-content-${pid}" class="flex-1 flex flex-col relative overflow-hidden">
                    <div id="q-container-${pid}" class="bg-black/30 rounded-lg p-2 mb-2 text-center border border-white/10 grow flex flex-col justify-center relative transition-all">
                        <p id="q-label-${pid}" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Cari Nilai X</p>
                        <div id="eq-${pid}" class="text-lg md:text-xl font-mono font-bold text-white my-1 flex justify-center items-center flex-wrap">...</div>
                    </div>

                    <div id="opts-${pid}" class="flex flex-col gap-2 h-auto justify-end"></div>

                    <div id="atk-overlay-${pid}" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-800/95 z-10">
                        <h3 class="text-sm font-bold text-white mb-2 uppercase">Serang!</h3>
                        <div id="atk-targets-${pid}" class="flex flex-col gap-2 w-full px-4"></div>
                    </div>

                    <div id="frozen-overlay-${pid}" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-red-900/90 z-20 text-center p-2">
                        <i id="feedback-icon-${pid}" class="fas fa-times-circle text-3xl text-white mb-1"></i>
                        <p id="feedback-text-${pid}" class="font-bold text-white text-sm">SALAH!</p>
                    </div>
                </div>
            `;
        }

        // --- LOGIC ---
        function startTimer(pid) {
            if(players[pid].timerInterval) clearInterval(players[pid].timerInterval);
            players[pid].timeLeft = gameTimeSetting;
            updateTimerUI(pid);

            players[pid].timerInterval = setInterval(() => {
                if(!gameActive || players[pid].isDead || players[pid].state !== 'THINKING') {
                    clearInterval(players[pid].timerInterval);
                    return;
                }
                players[pid].timeLeft--;
                updateTimerUI(pid);
                if(players[pid].timeLeft <= 0) handleTimeout(pid);
            }, 1000);
        }

        function updateTimerUI(pid) {
            const pct = (players[pid].timeLeft / gameTimeSetting) * 100;
            const bar = document.getElementById(`timer-fill-${pid}`);
            if(bar) {
                bar.style.width = `${pct}%`;
                if(pct < 30) bar.style.backgroundColor = '#ef4444';
                else bar.style.backgroundColor = '#fbbf24';
            }
        }

        function handleTimeout(pid) {
            clearInterval(players[pid].timerInterval);
            AudioSys.sfxWrong();
            const p = players[pid];
            p.hp = Math.max(0, p.hp - 10);
            updateHP(pid);
            
            showFeedback(pid, false, "WAKTU HABIS!");
            setTimeout(() => {
                if(!p.isDead && gameActive) {
                    resetPlayerState(pid);
                    generateQuestionFor(pid);
                }
            }, 1500);
        }

        function showFeedback(pid, isCorrect, msg) {
            const overlay = document.getElementById(`frozen-overlay-${pid}`);
            const icon = document.getElementById(`feedback-icon-${pid}`);
            const txt = document.getElementById(`feedback-text-${pid}`);
            
            overlay.classList.remove('hidden');
            if(isCorrect) {
                overlay.classList.remove('bg-red-900/90');
                overlay.classList.add('bg-green-600/90');
                icon.className = 'fas fa-check-circle text-3xl text-white mb-1';
                txt.textContent = msg || "BENAR! +HP";
            } else {
                overlay.classList.remove('bg-green-600/90');
                overlay.classList.add('bg-red-900/90');
                icon.className = 'fas fa-times-circle text-3xl text-white mb-1';
                txt.textContent = msg || "SALAH!";
            }
        }

        function resetPlayerState(pid) {
            const p = players[pid];
            p.state = 'THINKING';
            document.getElementById(`frozen-overlay-${pid}`).classList.add('hidden');
            document.getElementById(`q-container-${pid}`).classList.remove('bonus-mode');
        }

        // --- ADVANCED MATH GENERATOR ---
        function generateQuestionFor(pid) {
            if(players[pid].isDead || !gameActive) return;
            startTimer(pid);

            // Logic for Bonus Question (20% chance)
            const isBonus = Math.random() < 0.2;
            
            // Types: 
            // 0: ax + b = c (Simple)
            // 1: ax + b = cx + d (Variables both sides)
            // 2: Fraction (x/a + b = c)
            // 3: Brackets a(x + b) = c (HOTS/Bonus preferred)
            
            let type = Math.floor(Math.random() * 3); // 0, 1, 2
            if(isBonus) type = 3; // Bonus usually brackets

            let qHtml = '';
            let ans = 0;
            let x = Math.floor(Math.random() * 13) - 6; // -6 to 6
            if(x===0) x=2;

            // Setup UI for Bonus
            const qContainer = document.getElementById(`q-container-${pid}`);
            const qLabel = document.getElementById(`q-label-${pid}`);
            if(isBonus) {
                qContainer.classList.add('bonus-mode');
                qLabel.innerHTML = '<i class="fas fa-star text-yellow-400"></i> BONUS SOAL (HEAL)';
                qLabel.classList.add('text-yellow-300');
            } else {
                qContainer.classList.remove('bonus-mode');
                qLabel.textContent = 'CARI NILAI X';
                qLabel.classList.remove('text-yellow-300');
            }

            // Equation Generation
            if(type === 0) { 
                // ax + b = c
                let a = Math.floor(Math.random() * 5) + 2;
                let b = Math.floor(Math.random() * 20) - 10;
                let c = a*x + b;
                qHtml = `${a}x ${b>=0?'+':'-'} ${Math.abs(b)} = ${c}`;

            } else if(type === 1) { 
                // ax + b = cx + d
                let a = Math.floor(Math.random() * 4) + 3; 
                let c_coef = Math.floor(Math.random() * 2) + 1; 
                let b = Math.floor(Math.random() * 10) - 5;
                let d = (a-c_coef)*x + b;
                qHtml = `${a}x ${b>=0?'+':'-'} ${Math.abs(b)} = ${c_coef}x ${d>=0?'+':'-'} ${Math.abs(d)}`;

            } else if(type === 2) { 
                // Fraction: x/a + b = c
                let a = Math.floor(Math.random() * 3) + 2; // 2,3,4
                // Adjust x to be divisible by a for cleaner display, or just multiply everything
                x = x * a; // Ensure integer solution
                let b = Math.floor(Math.random() * 10) - 5;
                let c = (x/a) + b;
                
                // Display as fraction using HTML
                qHtml = `
                    <div class="fraction"><span class="top">x</span><span class="bottom">${a}</span></div>
                    ${b>=0?'+':'-'} ${Math.abs(b)} = ${c}
                `;

            } else { 
                // Bonus/HOTS: a(x + b) = c
                let a = Math.floor(Math.random() * 3) + 2;
                let b = Math.floor(Math.random() * 6) - 3;
                let val = x + b;
                let c = a * val;
                qHtml = `${a}(x ${b>=0?'+':'-'} ${Math.abs(b)}) = ${c}`;
            }

            players[pid].currentQ = { ans: x, isBonus: isBonus };
            document.getElementById(`eq-${pid}`).innerHTML = qHtml;
            
            // Options
            const optsBox = document.getElementById(`opts-${pid}`);
            optsBox.innerHTML = '';
            let options = new Set([x]);
            while(options.size < 4) {
                let fake = x + (Math.floor(Math.random() * 9) - 4);
                if(fake === x) fake = x + 1;
                options.add(fake);
            }
            
            Array.from(options).sort(() => Math.random()-0.5).forEach(val => {
                const btn = document.createElement('button');
                btn.className = `btn-option w-full py-3 rounded text-lg shadow-sm`;
                btn.textContent = val;
                btn.onpointerdown = (e) => { e.preventDefault(); handleAnswer(pid, val); };
                optsBox.appendChild(btn);
            });
        }

        function handleAnswer(pid, val) {
            const p = players[pid];
            if(p.state !== 'THINKING' || p.isDead || !gameActive) return;
            clearInterval(p.timerInterval);

            if(val === p.currentQ.ans) {
                if(p.currentQ.isBonus) {
                    // HEAL MODE
                    AudioSys.sfxHeal();
                    const healAmount = 20;
                    p.hp = Math.min(100, p.hp + healAmount);
                    updateHP(pid);
                    
                    // Visual Heal Effect
                    showFeedback(pid, true, `HEAL +${healAmount}!`);
                    const zone = document.getElementById(`p-zone-${pid}`);
                    
                    const popup = document.createElement('div');
                    popup.className = 'damage-popup heal-popup';
                    popup.innerText = `+${healAmount}`;
                    popup.style.left = '50%';
                    popup.style.top = '50%';
                    zone.appendChild(popup);
                    setTimeout(() => popup.remove(), 800);

                    setTimeout(() => {
                        resetPlayerState(pid);
                        generateQuestionFor(pid);
                    }, 1200);

                } else {
                    // ATTACK MODE
                    AudioSys.sfxCorrect();
                    enterAttackMode(pid);
                }
            } else {
                handleTimeout(pid); // Wrong answer penalty logic same as timeout
            }
        }

        function enterAttackMode(attackerId) {
            const p = players[attackerId];
            p.state = 'ATTACKING';
            
            const overlay = document.getElementById(`atk-overlay-${attackerId}`);
            const targetBox = document.getElementById(`atk-targets-${attackerId}`);
            targetBox.innerHTML = '';
            overlay.classList.remove('hidden');

            players.forEach((enemy, idx) => {
                if(idx !== attackerId && !enemy.isDead) {
                    const btn = document.createElement('button');
                    btn.className = `p-2 rounded border-2 ${enemy.border} bg-gray-700 flex items-center justify-between hover:bg-gray-600`;
                    btn.innerHTML = `
                        <span class="font-bold text-white text-xs">P${idx+1}</span>
                        <i class="fas ${enemy.icon} ${enemy.text} text-xl"></i>
                        <span class="text-xs text-gray-400">${enemy.hp} HP</span>
                    `;
                    btn.onpointerdown = (e) => { e.preventDefault(); performAttack(attackerId, idx); };
                    targetBox.appendChild(btn);
                }
            });
        }

        function performAttack(attackerId, victimId) {
            if(!gameActive) return;
            AudioSys.sfxAttack();
            
            const attacker = players[attackerId];
            const victim = players[victimId];
            const damage = 20;
            
            victim.hp = Math.max(0, victim.hp - damage);
            updateHP(victimId);
            
            document.getElementById(`atk-overlay-${attackerId}`).classList.add('hidden');
            attacker.state = 'THINKING';
            
            const vZone = document.getElementById(`p-zone-${victimId}`);
            vZone.classList.add('shake');
            
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.innerText = `-${damage}`;
            popup.style.left = '50%';
            popup.style.top = '30%';
            vZone.appendChild(popup);
            
            setTimeout(() => popup.remove(), 800);
            setTimeout(() => vZone.classList.remove('shake'), 400);

            generateQuestionFor(attackerId);
            if(victim.hp <= 0) handleDeath(victimId);
        }

        function updateHP(pid) {
            const p = players[pid];
            document.getElementById(`hp-bar-${pid}`).style.width = `${p.hp}%`;
            document.getElementById(`hp-txt-${pid}`).innerText = p.hp;
        }

        function handleDeath(pid) {
            players[pid].isDead = true;
            clearInterval(players[pid].timerInterval);
            const zone = document.getElementById(`p-zone-${pid}`);
            zone.classList.add('opacity-40', 'grayscale');
            
            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 overlay-dead flex items-center justify-center z-30';
            overlay.innerHTML = `<span class="text-4xl font-black text-red-500 rotate-[-15deg] border-4 border-red-500 p-2">KO!</span>`;
            zone.appendChild(overlay);
            checkWinCondition();
        }

        function checkWinCondition() {
            const survivors = players.filter(p => !p.isDead);
            if(survivors.length <= 1) {
                gameActive = false;
                AudioSys.startBGM(); // Stop or change BGM? Actually stop interval in sfxWin
                clearInterval(AudioSys.bgmInterval);
                AudioSys.sfxWin();
                players.forEach(p => clearInterval(p.timerInterval));
                
                const winner = survivors[0];
                const modal = document.getElementById('game-over');
                const winnerTxt = document.getElementById('winner-name');
                
                modal.classList.remove('hidden');
                if(winner) {
                    winnerTxt.innerText = `Player ${winner.id + 1} Menang!`;
                    winnerTxt.className = `text-3xl font-bold mb-8 ${winner.text}`;
                } else {
                    winnerTxt.innerText = "SERI!";
                    winnerTxt.className = "text-3xl font-bold mb-8 text-white";
                }
            }
        }
    </script>
</body>
</html>
